import bcrypt from "bcrypt";
import db from "../../config/db.js";
import nodemailer from "nodemailer";
import dotenv from "dotenv";
import path from "path";
import { fileURLToPath } from "url";


// ğŸ”¹ Add new stock
export const addStock = (req, res) => {
  const {
    product_name,
    description,
    price,
    quantity,
    category,
    supplier_id,
    received_by,
    received_date,
    product_condition,
  } = req.body;

  const sql = `
    INSERT INTO product_stock 
    (product_name, description, price, quantity, category, supplier_id, received_by, received_date, product_condition) 
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
  `;

  db.query(
    sql,
    [
      product_name,
      description,
      price,
      quantity,
      category,
      supplier_id,
      received_by,
      received_date,
      product_condition,
    ],
    (err, result) => {
      if (err) {
        console.error("âŒ Error inserting stock:", err);
        return res.status(500).json({ message: "Database error" });
      }
      res.status(200).json({ message: "âœ… Stock added successfully" });
    }
  );
};

// ğŸ”¹ Update product stock by ID
export const updateStockById = (req, res) => {
  const { id } = req.params;
  const {
    product_name,
    description,
    price,
    quantity,
    category,
    supplier_id,
    received_by,
    received_date,
    product_condition
  } = req.body;

  const sql = `
    UPDATE product_stock 
    SET product_name = ?, description = ?, price = ?, quantity = ?, category = ?, supplier_id = ?, 
        received_by = ?, received_date = ?, product_condition = ?
    WHERE id = ?
  `;

  db.query(
    sql,
    [
      product_name,
      description,
      price,
      quantity,
      category,
      supplier_id,
      received_by,
      received_date,
      product_condition,
      id,
    ],
    (err, result) => {
      if (err) {
        console.error("âŒ Error updating product stock:", err);
        return res.status(500).json({ message: "Database error" });
      }

      if (result.affectedRows === 0) {
        return res.status(404).json({ message: "Stock not found" });
      }

      res.status(200).json({ message: "âœ… Stock updated successfully" });
    }
  );
};


// ğŸ”¹ Get all stock records
export const getStock = (req, res) => {
  db.query("SELECT * FROM product_stock ORDER BY id ASC", (err, result) => {
    if (err) {
      console.error("âŒ Error fetching stock:", err);
      return res.status(500).json({ message: "Database error" });
    }
    res.status(200).json(result);
  });
};


// ğŸ”¹ Delete stock by ID
// ğŸ”¹ Archive stock instead of deleting
export const archiveStock = (req, res) => {
  const id = req.params.id;

  // Step 1: Get the stock data
  const selectQuery = 'SELECT * FROM product_stock WHERE id = ?';
  db.query(selectQuery, [id], (err, result) => {
    if (err) {
      console.error('âŒ Error selecting stock:', err);
      return res.status(500).json({ error: 'Database error' });
    }

    if (result.length === 0) {
      return res.status(404).json({ message: 'Stock item not found' });
    }

    const stock = result[0];

    // Step 2: Insert into archived_stock (include received_by and received_date)
    const insertQuery = `
      REPLACE INTO archived_stock 
      (id, product_name, description, price, quantity, category, supplier_id, created_at, received_by, received_date) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;

    const values = [
      stock.id,
      stock.product_name,
      stock.description,
      stock.price,
      stock.quantity,
      stock.category,
      stock.supplier_id,
      stock.created_at,
      stock.received_by,      // âœ… New field
      stock.received_date     // âœ… New field
    ];

    db.query(insertQuery, values, (err) => {
      if (err) {
        console.error('âŒ Error archiving stock:', err);
        return res.status(500).json({ error: 'Error inserting into archive' });
      }

      // Step 3: Delete from original table
      const deleteQuery = 'DELETE FROM product_stock WHERE id = ?';
      db.query(deleteQuery, [id], (err) => {
        if (err) {
          console.error('âŒ Error deleting stock:', err);
          return res.status(500).json({ error: 'Error deleting stock' });
        }

        res.status(200).json({ message: 'âœ… Stock archived successfully' });
      });
    });
  });
};

// ğŸ”¹ Get suppliers for dropdown (id + name only)
export const getSuppliers = (req, res) => {
  const sql = "SELECT id, name FROM supplier ORDER BY name ASC";
  db.query(sql, (err, result) => {
    if (err) {
      console.error("âŒ Error fetching suppliers:", err);
      return res.status(500).json({ message: "Database error" });
    }
    res.status(200).json(result);
  });
};

// ğŸ”¹ Get active employees for dropdown (id + name only)
// ğŸ”¹ Get active and non-archived employees (including position) for dropdown
export const getEmployees = (req, res) => {
 const sql = `
  SELECT id, name, position, isActive, is_archived
  FROM employee
  WHERE is_archived = 0
  ORDER BY name ASC
`;


  db.query(sql, (err, result) => {
    if (err) {
      console.error("âŒ Error fetching employees:", err);
      return res.status(500).json({ message: "Database error" });
    }
    res.status(200).json(result);
  });
};

// GET archived stock
export const getArchivedStock = (req, res) => {
  const sql = 'SELECT * FROM archived_stock';
  db.query(sql, (err, results) => {
    if (err) {
      console.error('Error fetching archived stock:', err);
      return res.status(500).json({ error: 'Internal server error' });
    }
    res.json(results);
  });
};

// ğŸ”¹ Add a new supplier
export const addSupplier = (req, res) => {
  const { product, name, contact, phone, address } = req.body;

  const sql = `
    INSERT INTO supplier (product, name, contact, phone, address)
    VALUES (?, ?, ?, ?, ?)
  `;

  db.query(sql, [product, name, contact, phone, address], (err, result) => {
    if (err) {
      console.error("âŒ Error inserting supplier:", err);
      return res.status(500).json({ message: "Database error" });
    }

    const newId = result.insertId;
    res.status(200).json({ message: "âœ… Supplier added successfully", id: newId });
  });
};